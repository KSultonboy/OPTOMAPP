name: Build Windows Executable

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build-windows:
    name: Build Windows installer (.exe)
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Install native printer module (Windows runner)
        shell: powershell
        run: |
          Write-Host "Installing printer native module (no-save, ignoring peer deps if needed)..."
          npm install printer --no-save --legacy-peer-deps
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Warning: printer install failed (non-fatal). Continue to build installer without native module."
            # Ensure this step does not fail the job
            exit 0
          }

      - name: Build web assets
        run: npm run web:build

      - name: Show Node/npm and web-build contents (debug)
        run: |
          echo "## Node / npm versions"
          node -v
          npm -v
          echo "## web-build folder contents"
          dir web-build || echo "web-build not found"
          echo "## root folder contents"
          dir

      - name: Build Windows installer
        env:
          # Optional: set these secrets in the repository to code-sign the installer
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}
        run: npm run electron:build

      - name: List dist/ contents (debug)
        run: dir dist

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: optomapp-windows
          path: dist/**
